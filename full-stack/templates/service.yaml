{{- $root := . -}}
{{- $defaults := .Values.serviceDefaults -}}

{{- range $serviceName, $service := .Values.services }}
{{- with $service }}
{{- if (or (not (hasKey . "enabled")) (.enabled)) }}
{{- if not .type }}
apiVersion: v1
kind: Service
metadata:
  name: {{ template "fullname" $root }}-{{ $serviceName }}
  labels:
    app: {{ template "name" $root }}
    chart: {{ $root.Chart.Name }}-{{ $root.Chart.Version | replace "+" "_" }}
    release: {{ $root.Release.Name }}
    heritage: {{ $root.Release.Service }}
  annotations:
    cloud.google.com/neg: '{"ingress": true}'
spec:
  selector:
    app: {{ template "name" $root }}
    release: {{ $root.Release.Name }}
    {{- if default $defaults.tier .tier }}
    tier: {{ default $defaults.tier .tier }}
    {{- end }}
    role: {{ $serviceName }}
  ports:
    - name: service
      port: {{ .port | default $defaults.port }}
    {{- if .sidecar }}
    {{- if .sidecar.enabled }}
    {{- if .sidecar.port }}
    - name: sidecar
      port: {{ .sidecar.port}}
    {{- end }}
    {{- end }}
    {{- end }}

---
{{- end }}
{{- end }}
{{- end }}
{{- end }}
